name: Test master branch locally (with Ubuntu)

# You can run it locally with these commands on macOS:
#
# brew install act
# act workflow_dispatch \
#  --container-architecture linux/amd64 \
#  -P ubuntu-latest=ghcr.io/catthehacker/ubuntu:act-22.04 \
#  -W crest4/tests/run.yml \
#  -j build \
#  -C "$(pwd)"

on: workflow_dispatch

jobs:
  build:

    runs-on: ubuntu-latest
    steps:

      # Clone *from the mounted local repo* into a fresh dir inside the container #
      - name: Make clean copy from local repo
        run: |
          set -euo pipefail

          SRC="${{ github.workspace }}"
          DEST=/repo

          echo "Workspace is: $SRC"
          if [ ! -d "$SRC/.git" ]; then
            echo "ERROR: GITHUB_WORKSPACE not a repository" >&2
            pwd
            ls -halt $SRC
            exit 1
          fi

          # Ensure git trusts the mounted path (act mount) #
          git config --global --add safe.directory "$SRC"

          # Capture the exact commit of your local HEAD #
          SHA="$(git -C "$SRC" rev-parse --verify HEAD)"

          # Clone from local filesystem into container-only path #
          git clone --no-hardlinks "file://$SRC" "$DEST"
          cd "$DEST"

          # Checkout the captured commit in detached HEAD (clean tree) #
          git checkout --detach "$SHA"
          echo "Checked out $SHA to $DEST"

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: 3.13

      - name: Upgrade pip itself
        run: python -m pip install --upgrade pip

      - name: Install the package from the git repo
        working-directory: /repo
        run: pip install ".[test]"

      - name: Update the APT package lists
        run: sudo apt-get update

      - name: Install BLAST and VSEARCH
        run: sudo apt-get install -y ncbi-blast+ vsearch

      - name: Test with pytest
        working-directory: /repo
        run: crest4 --pytest